#!/bin/bash

# TODO: make installer do an update if already installed

LOG_FILE=/tmp/nateflix-$(date +%Y%m%d%H%M%S).log

check_ports()
{
  # doing it this way now because netstat is not bundled with linux anymore
  # and I want to avoid installing yet another package
  # local ports=/80/443/6789/32400/3005/8324/32469/1900/32410/32412/32413/32414/8181/5000/8989/7878/8686/8112/58846/
  # local files="/proc/net/tcp /proc/net/tcp6 /proc/net/raw /proc/net/udp /proc/net/udp6"
  # local openPorts=$(cat ${files} | grep -v "local_address" | awk '{ print $2 }' | cut -d ':' -f 2 | sort -u)
  # local used=''
  #
  # for port in $openPorts; do
  #   local p=$((0x${port}))
  #   if [[ $(echo $ports | grep -q "/${port}/") != 0 ]]; then
  #     used="${used},${p}"
  #   fi
  # done

  local ports="80 443 6789 32400 3005 8324 32469 1900 32410 32412 32413 32414 8181 5000 8989 7878 8686 8112 58846"
  local used=''

  for port in $ports; do
    local result=$(lsof -Pi :${port} | tail -n +2 | grep -v "ESTABLISHED" | tail -n 1)
    if [[ ! -z $result ]]; then
      used="${used},$(echo ${result}|cut -d ' ' -f 1):${port}"
    fi
  done

  if [[ ! -z "${used}" ]]; then
    used=$(echo $used | cut -d ',' -f 2-)
    echo "Required ports are already in use (${used})"
    echo "These ports are required, please stop any services associated with these ports"
    exit 1
  fi
}

log()
{
  local timestamp=$(date "+%Y-%m-%d %H:%M:%S")
  echo "${timestamp} [${1}] ${2}" >> "${LOG_FILE}"
  if [[ $3 == 1 ]]; then
    echo "${2}"
  fi
}

get_var()
{
  source $2
  echo ${!1}
}

version_compare()
{
    if [[ $1 == $2 ]]
    then
        return 0
    fi
    local IFS=.
    local i ver1=($1) ver2=($2)
    # fill empty fields in ver1 with zeros
    for ((i=${#ver1[@]}; i<${#ver2[@]}; i++))
    do
        ver1[i]=0
    done
    for ((i=0; i<${#ver1[@]}; i++))
    do
        if [[ -z ${ver2[i]} ]]
        then
            # fill empty fields in ver2 with zeros
            ver2[i]=0
        fi
        if ((10#${ver1[i]} > 10#${ver2[i]}))
        then
            return 1
        fi
        if ((10#${ver1[i]} < 10#${ver2[i]}))
        then
            return 2
        fi
    done
    return 0
}

check_distro()
{
  export DISTRO=$(get_var ID /etc/os-release)
  export VERSION=$(get_var VERSION_ID /etc/os-release)

  if [[ -z $DISTRO ]]; then
    echo "Unable to determine linux distro"
    exit 1
  fi

  if [[ $(uname -m) != "x86_64" ]]; then
  	echo "This architecture is not supported ($(uname -m))"
  	exit 1
  fi

  if [[ "$DISTRO" == "debian" && $(version_compare $VERSION "7.6"; echo $?) != 1 ]]; then
    echo "Requires Debian 7.7 or higher"
    exit 1
  elif [[ "$DISTRO" == "ubuntu" && $(version_compare $VERSION "14.03"; echo $?) != 1 ]]; then
    echo "Requires Ubuntu 14.04 or higher"
    exit 1
  elif [[ "$DISTRO" == "centos" && $(version_compare $VERSION "6"; echo $?) != 1 ]]; then
    echo "Requires CentOS 7 or higher"
    exit 1
  elif [[ "$DISTRO" == "fedora" && $(version_compare $VERSION "25"; echo $?) != 1 ]]; then
    echo "Requires Fedora 26 or higher"
    exit 1
  fi
}

cleanup()
{
  if [[ -d $1 ]]; then
    rm -rf $1
  fi
}

check_if_running()
{
  local http_status='0'
  local http_content=''
  local retries=${4:-20}
  local out=''

  # while [[ $http_status != "$2" || $http_content != *"$3"* ]]; do
  while [[ $http_status != "$2" || ! "${http_content}" =~ "${3}" ]]; do
    out=$(curl -k --silent -L -w "\n%{http_code}" "$1")
    http_status="${out##*$'\n'}"
    http_content="${out%$'\n'*}"
    retries=$(($retries-1))
    if [[ $retries -lt 0 ]]; then
      echo "Service did not properly start"
      exit 1
    fi
    sleep 1
  done

  return 0
}

extract()
{
  local archive=$(awk '/^__ARCHIVE__/ {print NR + 1; exit 0; }' "${0}")
  tail -n+${archive} "${0}" | tar xpJv -C $1 >> $LOG_FILE 2>&1
}

get_value()
{
    read -ep "$1 [$2]? " value
    if [[ ! -z "$value" ]]; then
      echo $value
    else
      echo $2
    fi
}

install_dependencies()
{
  if [[ $(hash docker 2>/dev/null; echo $?) != 0 ]]; then
    echo "docker is not installed"
    echo "please install the latest version of docker"
    echo "https://docs.docker.com/install/linux/docker-ce/${DISTRO}/"
    exit 1
  fi

  if [[ $(hash docker-compose 2>/dev/null; echo $?) != 0 ]]; then
    echo "docker-compose is not installed"
    echo "please install the latest version of docker compose"
    echo "https://docs.docker.com/compose/install/"
    exit 1
  fi

  local dockerVersion=$(docker --version|cut -d ' ' -f 3|cut -d ',' -f 1)
  local dcVersion=$(docker-compose --version|cut -d ' ' -f 3|cut -d ',' -f 1)
  if [[ $(version_compare $dockerVersion "18.09.0"; echo $?) == 2 ]]; then
    echo "Your docker version (${dockerVersion}) is not supported"
    echo "Version >= 18.09.0 is required"
    echo "Please update your docker https://docs.docker.com/install/linux/docker-ce/${DISTRO}/"
    exit 1
  fi

  if [[ $(version_compare $dcVersion "1.23.2"; echo $?) == 2 ]]; then
    echo "Your docker-compose version (${dcVersion}) is not supported"
    echo "Version >= 1.23.2 is required"
    echo "Please update your docker-compose https://docs.docker.com/compose/install/"
    exit 1
  fi

  local packageUpdate='apt-get -qq update'
  local packageInstall='apt-get -qq -y install'
  if [[ "${DISTRO}" == "centos" ]]; then
    packageUpdate=''
    packageInstall='yum install -y'
  elif [[ "${DISTRO}" == "fedora" ]]; then
    packageUpdate=''
    packageInstall='dnf -y install'
  fi

  echo "Installing dependencies..."
  ${packageUpdate}
  ${packageInstall} rsync sqlite3 curl >> $LOG_FILE 2>&1

  systemctl start docker
}

gather_required_config()
{
  echo
  echo
  echo "**************************"
  echo "* INITIAL CONFIGURATION  *"
  echo "**************************"
  echo

  CONFIG_DIR=/nateflix
  export CONFIG_DIR
  PLEX_HOSTNAME=Nateflix
  export PLEX_HOSTNAME

  log "INFO" "Gathering credentials..."
  read -ep "Plex username: " PLEX_USERNAME
  read -esp "Plex password: " PLEX_PASSWORD
  echo
  export PLEX_USERNAME
  export PLEX_PASSWORD
  if [[ -z "${PLEX_USERNAME}" || -z "${PLEX_PASSWORD}" ]]; then
    echo "Plex username and password required"
    exit 1;
  fi

  local result=$(curl -s --header "X-Plex-Client-Identifier: Nateflix" \
          --header "X-Plex-Product: Nateflix Installation" \
          --header "X-Plex-Version: V1" \
          -d "user[login]=${PLEX_USERNAME}&user[password]=${PLEX_PASSWORD}" \
          -X POST https://plex.tv/users/sign_in.json)
  local re="^\{\"error\":\"(.+)\"\}$"
  if [[ $result =~ $re ]]; then
    log "ERROR" "Login failed: ${BASH_REMATCH[1]}" 1
    exit 1
  fi
  if [[ $result != *"{\"user\":"* ]]; then
    log "ERROR" "Login failed: Unexpected result" 1
    exit 1
  fi

  PLEX_TOKEN=$(echo $result | grep -ioe '"authToken":"[^"]*' | cut -c 14-)
  export PLEX_TOKEN
  PLEX_CLAIM="not a real token"
  export PLEX_CLAIM

  echo "PORTAL CREDENTIALS"
  read -ep "Portal Username: " PORTAL_USERNAME
  PORTAL_PASSWORD=$(openssl passwd -apr1)
  while [[ "$?" != "0" ]]; do
    PORTAL_PASSWORD=$(openssl passwd -apr1)
  done
  #PORTAL_PASSWORD=$(echo "${PORTAL_PASSWORD}"|sed -e s/\\$/\\$\\$/g)
  export PORTAL_CREDS="${PORTAL_USERNAME}:${PORTAL_PASSWORD}"

  read -ep "PIA VPN Username: " VPN_USERNAME
  read -esp "PIA VPN Password: " VPN_PASSWORD
  echo
  export VPN_USERNAME
  export VPN_PASSWORD
  if [[ -z "${VPN_USERNAME}" || -z "${VPN_PASSWORD}" ]]; then
    echo "VPN username and password are required"
    exit 1;
  fi

  echo

  DOMAIN=nateflix.io
  # DOMAIN=$(get_value "Nateflix domain name" $DOMAIN)
  export DOMAIN

  ADVERTISE_IP=192.168.1.147
  ADVERTISE_IP=$(get_value "IP address of this server" $ADVERTISE_IP)
  export ADVERTISE_IP

  INSTALL_DIR="/opt/nateflix"
  # INSTALL_DIR=$(get_value "Where do you want to install Nateflix" $INSTALL_DIR)
  # if [[ -d $INSTALL_DIR ]]; then
  #   read -ep "Directory already exists, overwrite [n]? " yn
  #   case $yn in
  #     [Yy]* )
  #       #rm -rf $INSTALL_DIR
  #       ;;
  #     *)
  #       echo "Aborting installation"
  #       exit 1
  #       ;;
  #   esac
  # fi
  # if [[ $(mkdir -p $INSTALL_DIR > /dev/null 2>&1; echo $?) == 0 ]]; then
  #   rm -rf $INSTALL_DIR
  # else
  #   echo "Could not create destination directory"
  #   exit 1
  # fi
  export INSTALL_DIR

  MEDIA_ROOT=/mnt/media
  MEDIA_ROOT=$(get_value "Root location of media library" $MEDIA_ROOT)
  export MEDIA_ROOT

  TZ=$(date +%Z)
  export TZ
}

install()
{
  gather_required_config
  # install_docker

  echo
  echo
  echo "**************************"
  echo "*  INSTALLING NATEFLIX   *"
  echo "**************************"
  echo

  log "INFO" "Extracting files" 1
  extract $WORKING_DIR

  log "INFO" "Creating directories" 1
  mkdir -p $INSTALL_DIR
  mkdir -p $MEDIA_ROOT
  mkdir -p $CONFIG_DIR/portal

  log "INFO" "Copying files" 1
  cp -Rv $WORKING_DIR/. $INSTALL_DIR >> $LOG_FILE 2>&1
  touch $INSTALL_DIR/.env

  cp $INSTALL_DIR/portal/config.toml $CONFIG_DIR/portal
  echo ${PORTAL_CREDS} > $CONFIG_DIR/portal/users

  if [[ -e /usr/local/sbin/nateflix ]]; then
    rm /usr/local/sbin/nateflix
  fi
  ln -s $INSTALL_DIR/nateflix /usr/local/sbin/nateflix

  cd $INSTALL_DIR
  build_and_configure

  echo "Setting TZ to ${TZ}" >> $LOG_FILE
  echo TZ=$TZ >> $INSTALL_DIR/.env
  echo "Setting CONFIG_DIR to ${CONFIG_DIR}" >> $LOG_FILE
  echo CONFIG_DIR=$CONFIG_DIR >> $INSTALL_DIR/.env
  echo "Setting MEDIA_ROOT to ${MEDIA_ROOT}" >> $LOG_FILE
  echo MEDIA_ROOT=$MEDIA_ROOT >> $INSTALL_DIR/.env
  echo "Setting PLEX_CLAIM to ${PLEX_CLAIM}" >> $LOG_FILE
  echo PLEX_CLAIM=$PLEX_CLAIM >> $INSTALL_DIR/.env
  echo "Setting DOMAIN to ${DOMAIN}" >> $LOG_FILE
  echo DOMAIN=$DOMAIN >> $INSTALL_DIR/.env
  echo "Setting ADVERTISE_IP to ${ADVERTISE_IP}" >> $LOG_FILE
  echo ADVERTISE_IP=$ADVERTISE_IP >> $INSTALL_DIR/.env
  echo "Setting PLEX_HOSTNAME to ${PLEX_HOSTNAME}" >> $LOG_FILE
  echo PLEX_HOSTNAME=$PLEX_HOSTNAME >> $INSTALL_DIR/.env

  echo
  echo
  echo "Installation complete"
  echo
  echo

  docker-compose up -d
}

configure_lidarr()
{
  echo
  echo
  echo "**************************"
  echo "*   CONFIGURING LIDARR   *"
  echo "**************************"
  echo

  log "INFO" "Configuring Lidarr"
  local dbFile=$CONFIG_DIR/lidarr/lidarr.db
  if [[ -f $dbFile ]]; then
    log "INFO" "Lidarr already configured; skipping..." 1
    return
  fi

  docker-compose up -d lidarr
  check_if_running 'http://localhost:8686' 200 'Lidarr' 30
  docker-compose stop lidarr

  sqlite3 $dbFile "insert into Config (Key,Value) values ('autounmonitorpreviouslydownloadedtracks', 'True')"
  sqlite3 $dbFile "insert into Config (Key,Value) values ('deleteemptyfolders', 'True')"
  sqlite3 $dbFile "insert into Config (Key,Value) values ('copyusinghardlinks', 'False')"
  sqlite3 $dbFile "insert into Config (Key,Value) values ('removecompleteddownloads', 'True')"
  sqlite3 $dbFile "insert into DownloadClients (Enable,Name,Implementation,Settings,ConfigContract) values (1,'nzbget','Nzbget','{\"host\":\"nzbget\",\"port\":6789,\"username\":\"\",\"password\":\"\",\"musicCategory\":\"Music\",\"recentTvPriority\":0,\"olderTvPriority\":0,\"addPaused\":false,\"useSsl\":false}','NzbgetSettings')"
  sqlite3 $dbFile "insert into DownloadClients (Enable,Name,Implementation,Settings,ConfigContract) values (1,'deluge','Deluge','{\"host\":\"deluge\",\"port\":8112,\"username\":\"\",\"password\":\"\",\"musicCategory\":\"lidarr\",\"recentTvPriority\":0,\"olderTvPriority\":0,\"addPaused\":false,\"useSsl\":false}','DelugeSettings')"
  sqlite3 $dbFile "insert into Notifications (Name,OnGrab,OnDownload,Settings,Implementation,ConfigContract,OnUpgrade,Tags,OnRename,OnAlbumDownload) values ('plex',0,1,'{\"host\":\"plex\",\"port\":32400,\"username\":\"${PLEX_USERNAME}\",\"password\":\"${PLEX_PASSWORD}\",\"updateLibrary\":true,\"useSsl\":false,\"isValid\":true}','PlexServer','PlexServerSettings',1,'[]',1,1)"
  sed -i -e "s/<\/Config>/<LaunchBrowser>False<\/LaunchBrowser>\n<\/Config>/" $CONFIG_DIR/lidarr/config.xml
  sed -i -e "s/<\/Config>/<AnalyticsEnabled>False<\/AnalyticsEnabled>\n<\/Config>/" $CONFIG_DIR/lidarr/config.xml
}

configure_plex()
{
  echo
  echo
  echo "**************************"
  echo "*    CONFIGURING PLEX    *"
  echo "**************************"
  echo

  log "INFO" "Configuring Plex"
  if [[ -f "${CONFIG_DIR}/plex/config/Library/Application Support/Plex Media Server/Preferences.xml" ]]; then
    log "INFO" "Plex already configured; skipping..." 1
    return
  fi

  log "INFO" "Getting Plex claim token" 1
  local result=$(curl -s --header "X-Plex-Client-Identifier: Nateflix" \
          --header "X-Plex-Product: Nateflix Installation" \
          --header "X-Plex-Token: ${PLEX_TOKEN}" \
          -X GET https://plex.tv/api/claim/token.json)

  PLEX_CLAIM=$(echo $result | grep -ioe '"token":"[^"]*' | cut -c 10-)
  export PLEX_CLAIM
  if [[ -z $PLEX_CLAIM ]]; then
    echo "Error retrieving Plex Claim Token"
    exit 1;
  fi

  docker-compose up -d plex
  check_if_running 'http://localhost:32400/web/index.html' 200 "Plex" 500
  docker-compose stop plex
}

configure_nzbget()
{
  echo
  echo
  echo "**************************"
  echo "*   CONFIGURING NZBGET   *"
  echo "**************************"
  echo

  log "INFO" "Configuring NzbGet"
  local configFile=$CONFIG_DIR/nzbget/config/nzbget.conf
  if [[ -f $configFile ]]; then
    log "INFO" "NzbGet already configured; skipping..." 1
    return
  fi

  docker-compose up -d nzbget
  check_if_running 'http://localhost:6789' 401 '' 10
  docker-compose stop nzbget

  sed -i -e "s/^\(ControlUsername\).\+$/\1=/g" $configFile
  sed -i -e "s/^\(ControlPassword\).\+$/\1=/g" $configFile
}

make_api_call()
{
  curl -Ls -H 'Content-Type: application/json' \
       -H "ApiKey: $1" \
       -d "$3" "http://localhost:5000/api/v1/$2"
}

configure_ombi()
{
  echo
  echo
  echo "**************************"
  echo "*    CONFIGURING OMBI    *"
  echo "**************************"
  echo

  log "INFO" "Configuring OMBI"
  if [[ -f ${CONFIG_DIR}/ombi/Ombi.db ]]; then
    log "INFO" "OMBI already configured; skipping..." 1
    return
  fi

  docker-compose up -d ombi
  check_if_running 'http://localhost:5000' 200 'Ombi'

  local apiKey=$(grep -aioe '"ApiKey":"[^"]*' ${CONFIG_DIR}/ombi/Ombi.db | cut -c 11-)
  local sonarrKey=$(cat ${CONFIG_DIR}/sonarr/config.xml | grep -aioe "<ApiKey>[^<]*" | cut -c 9-)
  local radarrKey=$(cat ${CONFIG_DIR}/radarr/config.xml | grep -aioe "<ApiKey>[^<]*" | cut -c 9-)

  make_api_call "${apiKey}" "Issues/categories" '{"value":"Shows"}'
  make_api_call "${apiKey}" "Issues/categories" '{"value":"Movies"}'
  make_api_call "${apiKey}" "Issues/categories" '{"value":"Foreign Movies"}'
  make_api_call "${apiKey}" "Issues/categories" '{"value":"Anime Movies"}'
  make_api_call "${apiKey}" "Issues/categories" '{"value":"Anime Shows"}'

  make_api_call "${apiKey}" "Settings/customization" "{\"applicationName\":\"Nateflix\",\"applicationUrl\":\"https://request.${DOMAIN}\"}"
  make_api_call "${apiKey}" "Settings/Issues" '{"enabled":true,"enableInProgress":true}'
  make_api_call "${apiKey}" "Settings/authentication" '{"allowNoPassword":false,"enableOAuth":true}'

  local data=$(cat <<- EOD
  {"enabled": true,
  "apiKey": "${sonarrKey}",
  "qualityProfile": "6",
  "seasonFolders": true,
  "qualityProfileAnime": "6",
  "addOnly": false,
  "ssl": false,
  "ip": "sonarr",
  "port": 8989}
EOD
)
  make_api_call "${apiKey}" "Settings/sonarr" "${data}"

  data=$(cat <<- EOD
  {"enabled": true,
  "apiKey": "${radarrKey}",
  "defaultQualityProfile": "6",
  "addOnly": false,
  "minimumAvailability": "Released",
  "ssl": false,
  "ip": "radarr",
  "port": 7878}
EOD
)
  make_api_call "${apiKey}" "Settings/radarr" "${data}"

#   data=$(cat <<- EOD
#   {
#     "enable": true,
#     "installId": "string",
#     "servers": [
#       {
#         "name": "Nateflix",
#         "episodeBatchSize": 0,
#         "ssl": true,
#         "ip": "plex",
#         "port": 32400
#       }
#     ]
#   }
# EOD
# )

#   data=$(cat <<- EOD
#   {
#     "enable": true,
#     "servers": [
#       {
#         "name": "Nateflix",
#         "plexSelectedLibraries": [
#           {
#             "enabled": true
#           }
#         ],
#         "ssl": true,
#         "ip": "plex",
#         "port": 32400
#       }
#     ]
#   }
# EOD
# )
#   make_api_call "${apiKey}" "Settings/plex" "${data}"

  docker-compose stop ombi
}

configure_sonarr()
{
  echo
  echo
  echo "**************************"
  echo "*   CONFIGURING SONARR   *"
  echo "**************************"
  echo

  log "INFO" "Configuring Sonarr"
  local dbFile=$CONFIG_DIR/sonarr/nzbdrone.db
  if [[ -f $dbFile ]]; then
    log "INFO" "Sonarr already configured; skipping..." 1
    return
  fi

  docker-compose up -d sonarr
  check_if_running 'http://localhost:8989' 200 'Sonarr'
  docker-compose stop sonarr

  sqlite3 $dbFile "insert into Config (Key,Value) values ('cleanupmetadataimages', 'False')"
  sqlite3 $dbFile "insert into Config (Key,Value) values ('removecompleteddownloads', 'True')"
  sqlite3 $dbFile "insert into DownloadClients (Enable,Name,Implementation,Settings,ConfigContract) values (1, 'nzbget', 'Nzbget', '{\"host\": \"nzbget\", \"port\": 6789, \"username\": \"\", \"password\": \"\", \"tvCategory\": \"Series\", \"recentTvPriority\": 0, \"olderTvPriority\": 0, \"useSsl\": false}', 'NzbgetSettings')"
  sqlite3 $dbFile "insert into DownloadClients (Enable,Name,Implementation,Settings,ConfigContract) values (1, 'deluge', 'Deluge', '{\"host\": \"deluge\", \"port\": 8112, \"password\": \"\", \"tvCategory\": \"tv-sonarr\", \"recentTvPriority\": 0, \"addPaused\": false, \"olderTvPriority\": 0, \"useSsl\": false}', 'DelugeSettings')"
  sqlite3 $dbFile "insert into Notifications (Name,OnGrab,OnDownload,Settings,Implementation,ConfigContract,OnUpgrade,Tags,OnRename) values ('pms', 0, 1, '{\"host\": \"plex\", \"port\": 32400, \"username\": \"${PLEX_USERNAME}\", \"password\": \"${PLEX_PASSWORD}\", \"updateLibrary\": true, \"useSsl\": false, \"isValid\": true}', 'PlexServer', 'PlexServerSettings', 1, '[]', 1)"
  sqlite3 $dbFile "insert into NamingConfig (MultiEpisodeStyle,RenameEpisodes,StandardEpisodeFormat,DailyEpisodeFormat,SeasonFolderFormat,SeriesFolderFormat,AnimeEpisodeFormat,ReplaceIllegalCharacters) values (0,1,'{Series Title} - S{season:00}E{episode:00} - {Episode Title} {Quality Full}','{Series Title} - {Air-Date} - {Episode Title} {Quality Full}','Season {season}','{Series Title}','{Series Title} - S{season:00}E{episode:00} - {Episode Title} {Quality Full}',1)"
  sed -i -e "s/<LaunchBrowser>True<\/LaunchBrowser>/<LaunchBrowser>False<\/LaunchBrowser>/" $CONFIG_DIR/sonarr/config.xml
  sed -i -e "s/<\/Config>/<AnalyticsEnabled>False<\/AnalyticsEnabled>\n<\/Config>/" $CONFIG_DIR/sonarr/config.xml
}

configure_radarr()
{
  echo
  echo
  echo "**************************"
  echo "*   CONFIGURING RADARR   *"
  echo "**************************"
  echo

  log "INFO" "Configuring Radarr"
  local dbFile=$CONFIG_DIR/radarr/nzbdrone.db
  if [[ -f $dbFile ]]; then
    log "INFO" "Radarr already configured; skipping..." 1
    return
  fi

  docker-compose up -d radarr
  check_if_running 'http://localhost:7878' 200 'Radarr'
  docker-compose stop radarr

  sqlite3 $dbFile "insert into Config (Key,Value) values ('cleanupmetadataimages', 'False')"
  sqlite3 $dbFile "insert into Config (Key,Value) values ('removecompleteddownloads', 'True')"
  sqlite3 $dbFile "insert into DownloadClients (Enable,Name,Implementation,Settings,ConfigContract) values (1, 'nzbget', 'Nzbget', '{\"host\": \"nzbget\", \"port\": 6789, \"username\": \"\", \"password\": \"\", \"tvCategory\": \"Series\", \"recentTvPriority\": 0, \"olderTvPriority\": 0, \"useSsl\": false}', 'NzbgetSettings')"
  sqlite3 $dbFile "insert into DownloadClients (Enable,Name,Implementation,Settings,ConfigContract) values (1, 'deluge', 'Deluge', '{\"host\": \"deluge\", \"port\": 8112, \"password\": \"\", \"tvCategory\": \"radarr\", \"recentTvPriority\": 0, \"addPaused\": false, \"olderTvPriority\": 0, \"useSsl\": false}', 'DelugeSettings')"
  sqlite3 $dbFile "insert into Notifications (Name,OnGrab,OnDownload,Settings,Implementation,ConfigContract,OnUpgrade,Tags,OnRename) values ('pms', 0, 1, '{\"host\": \"plex\", \"port\": 32400, \"username\": \"${PLEX_USERNAME}\", \"password\": \"${PLEX_PASSWORD}\", \"updateLibrary\": true, \"useSsl\": false, \"isValid\": true}', 'PlexServer', 'PlexServerSettings', 1, '[]', 1)"
  sqlite3 $dbFile "insert into NamingConfig (MultiEpisodeStyle,RenameEpisodes,ReplaceIllegalCharacters,StandardMovieFormat,MovieFolderFormat,ColonReplacementFormat) values (0,1,1,'{Movie Title} {Release Year} {Quality Title}','{Movie Title} ({Release Year})',1)"
  sed -i -e "s/<LaunchBrowser>True<\/LaunchBrowser>/<LaunchBrowser>False<\/LaunchBrowser>/" $CONFIG_DIR/radarr/config.xml
  sed -i -e "s/<\/Config>/<AnalyticsEnabled>False<\/AnalyticsEnabled>\n<\/Config>/" $CONFIG_DIR/radarr/config.xml
}

configure_plexstats()
{
  echo
  echo
  echo "**************************"
  echo "* CONFIGURING PLEX STATS *"
  echo "**************************"
  echo

  log "INFO" "Configuring Plex Stats"
  local configFile=$CONFIG_DIR/plexstats/config.ini
  if [[ -f $configFile ]]; then
    log "INFO" "Plex Stats already configured; skipping..." 1
    return
  fi

  docker-compose up -d plexstats
  check_if_running 'http://localhost:8181' 200 'Tautulli - Welcome' 500
  docker-compose stop plexstats

  sed -i -e "s/^\(pms_url\) =.\+$/\1 = http:\/\/plex:32400/g" $configFile
  sed -i -e "s/^\(pms_name\) =.\+$/\1 = ${PLEX_HOSTNAME}/g" $configFile
  sed -i -e "s/^\(pms_plexpass\) =.\+$/\1 = 1/g" $configFile
  sed -i -e "s/^\(pms_port\) =.\+$/\1 = 32400/g" $configFile
  sed -i -e "s/^\(pms_platform\) =.\+$/\1 = Linux/g" $configFile
  sed -i -e "s/^\(pms_ip\) =.\+$/\1 = plex/g" $configFile
  sed -i -e "s/^\(launch_browser\) =.\+$/\1 = 0/g" $configFile
  sed -i -e "s/^\(show_advanced_settings\) =.\+$/\1 = 1/g" $configFile
  sed -i -e "s/^\(pms_logs_folder\) =.\+$/\1 = \/logs/g" $configFile
}

configure_deluge()
{
  echo
  echo
  echo "**************************"
  echo "*   CONFIGURING DELUGE   *"
  echo "**************************"
  echo

  log "INFO" "Configuring Deluge"
  if [[ -f ${CONFIG_DIR}/deluge/core.conf && -f  ${CONFIG_DIR}/deluge-web/web.conf ]]; then
    log "INFO" "Deluge already configured; skipping..." 1
    return
  fi

  docker-compose up -d deluge
  check_if_running 'http://localhost:8112' 200 'Deluge'
  while [[ ! -f ${CONFIG_DIR}/deluge/auth ]]; do
    sleep 1s
  done
  docker-compose stop deluge

  echo ${VPN_USERNAME} > ${CONFIG_DIR}/openvpn/auth.txt
  echo ${VPN_PASSWORD} >> ${CONFIG_DIR}/openvpn/auth.txt
  echo "::10" > ${CONFIG_DIR}/deluge/auth

  sed -i -e "s/^\(.\+\"pwd_sha1\": \"\)[a-f0-9]\{40\}\(.\+\)$/\\1\\2/g" ${CONFIG_DIR}/deluge-web/web.conf
  sed -i -e "s/^\(.\+\"pwd_salt\": \"\)[a-f0-9]\{40\}\(.\+\)$/\\1\\2/g" ${CONFIG_DIR}/deluge-web/web.conf
}

build_and_configure()
{
  echo
  echo
  echo "**************************"
  echo "*    BUILDING IMAGES     *"
  echo "**************************"
  echo

  docker-compose build --no-cache >> $LOG_FILE
  if [[ "$?" -gt 0 ]]; then
    echo "Error building images check log file ${LOG_FILE} for details"
    exit $?
  fi

  configure_plex
  configure_nzbget
  configure_lidarr
  configure_sonarr
  configure_radarr
  configure_ombi
  configure_plexstats
  configure_deluge
}


if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root"
   exit 1
fi

WORKING_DIR=$(mktemp -d)
trap "cleanup \"${WORKING_DIR}\"" EXIT


check_ports
check_distro
install_dependencies
install


echo
echo "You may need to perform some extra setup steps in each application"
echo
echo "NZBGet:     http://newz.${DOMAIN}"
echo "Plex:       http://watch.${DOMAIN}"
echo "Plex Stats: http://stats.${DOMAIN}"
echo "Lidarr:     http://music.${DOMAIN}"
echo "Sonarr:     http://shows.${DOMAIN}"
echo "Radarr:     http://movies.${DOMAIN}"
echo "OMBI:       http://request.${DOMAIN}"
echo "Deluge:     http://torrents.${DOMAIN}"
echo "Portal:     http://portal.${DOMAIN}"
echo
echo

exit $?

__ARCHIVE__
